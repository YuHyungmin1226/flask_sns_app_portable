{% extends "base.html" %}

{% block title %}메인 피드 - Flask SNS{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <h1 class="mb-4">최신 게시물</h1>
        
        <div id="post-container">
            {% include '_posts_list.html' %}
        </div>

        <div id="loading-indicator" class="text-center" style="display: none;">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        
        {% if not posts_pagination.items %}
            <div class="text-center p-5 border rounded">
                <p class="lead">아직 게시물이 없습니다.</p>
                <a href="{{ url_for('new_post') }}" class="btn btn-dark">첫 게시물 작성하기</a>
            </div>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let page = {{ posts_pagination.page }};
        let hasNext = {{ posts_pagination.has_next|tojson }};
        let isLoading = false;
        const loadingIndicator = document.getElementById('loading-indicator');
        const postContainer = document.getElementById('post-container');

        window.addEventListener('scroll', () => {
            if (!hasNext || isLoading) return;

            // Check if user has scrolled to the bottom of the page
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
                isLoading = true;
                loadingIndicator.style.display = 'block';
                page++;

                fetch(`/?page=${page}`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.text())
                .then(html => {
                    if (html.trim() !== "") {
                        postContainer.insertAdjacentHTML('beforeend', html);
                        isLoading = false;
                    } else {
                        hasNext = false;
                    }
                    loadingIndicator.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error fetching more posts:', error);
                    isLoading = false;
                    loadingIndicator.style.display = 'none';
                });
            }
        });
    });
</script>
{% endblock %}
